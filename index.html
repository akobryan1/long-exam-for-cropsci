<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Agricultural Biotechnology Final Exam</title>
  <style>
    body {
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
      background:#0f172a;
      color:#e5e7eb;
    }
    .wrap {
      max-width:960px;
      margin:0 auto;
      padding:24px;
    }
    .card {
      background:#111827;
      border:1px solid #1f2937;
      border-radius:16px;
      padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h1,h2 {
      margin:0 0 10px 0;
      color:#e2e8f0;
    }
    ul {
      padding-left:20px;
    }
    .pill {
      padding:6px 10px;
      border-radius:999px;
      background:#111827;
      border:1px solid #1f2937;
      font-size:12px;
      margin-right:6px;
      display:inline-block;
    }
    .meta-row {
      margin-bottom:10px;
    }
    .field {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:10px 0;
    }
    input[type="text"] {
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #334155;
      background:#0b1220;
      color:#e5e7eb;
      flex:1;
      min-width:220px;
    }
    button {
      padding:10px 16px;
      border-radius:12px;
      border:1px solid #263042;
      background:#0b1326;
      color:#e5e7eb;
      cursor:pointer;
    }
    button.primary {
      background:#0d5a30;
    }
    button:disabled {
      opacity:.6;
      cursor:not-allowed;
    }
    .progress {
      height:8px;
      background:#1f2937;
      border-radius:999px;
      margin-bottom:12px;
      overflow:hidden;
    }
    .bar {
      height:100%;
      width:0%;
      background:#22c55e;
      transition:width .2s ease-out;
    }
    #choices {
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:12px;
    }
/* FIX CHOICES OVERFLOWING HORIZONTALLY */
#choices {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
}

.choice {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  width: 100%;
  max-width: 100% !important;
  background: #0b1220;
  border: 1px solid #1f2937;
  border-radius: 10px;
  padding: 12px;
  box-sizing: border-box;
}

.choice input {
  margin-top: 4px;
  flex-shrink: 0;
}

.choice div {
  flex: 1;
  white-space: normal !important;
  overflow-wrap: break-word !important;
  word-break: break-word !important;
}


    .choice b {
  display: inline-block;
  width: 22px;          /* fixed width for letters A/B/C/D */
}

    .footer {
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:20px;
      flex-wrap:wrap;
    }
    .hidden {
      display:none;
    }
    .error {
      color:#fecaca;
      font-size:13px;
      margin-top:6px;
    }
    .small {
      font-size:12px;
      color:#9ca3af;
    }
    @media (max-width:600px) {
      .footer {
        flex-direction:column;
        align-items:stretch;
      }
      button {
        width:100%;
      }
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Agricultural Biotechnology Final Exam</h1>

    <div id="meta" class="meta-row hidden">
      <span class="pill" id="pillName">Name: —</span>
      <span class="pill" id="pillSection">Year/Section: —</span>
      <span class="pill" id="pillTimer">Time: 60:00</span>
      <span class="pill" id="pillCount">Q: — / —</span>
    </div>

    <!-- Stage 0: Instructions -->
    <section id="stage0">
      <h2>Exam Instructions</h2>
      <ul>
        <li>This exam is <strong>screen recorded</strong>.</li>
        <li>You have <strong>1 hour</strong> to finish once you start.</li>
        <li>You may take the exam <strong>twice</strong>. After the second attempt, all further attempts are blocked.</li>
        <li>The link closes at <strong>11:59:59 PM on 21 November 2025</strong>. After this, you will not be able to access the exam.</li>
      </ul>
      <p class="small">Make sure you have a stable internet connection. Do not close the tab while taking the exam.</p>
      <div class="error" id="errStage0" style="display:none;"></div>
      <button class="primary" id="btnUnderstand">I understand</button>
    </section>

    <!-- Stage 1: Student Info -->
    <section id="stage1" class="hidden">
      <h2>Student Information</h2>
      <div class="field">
        <input type="text" id="inpName" placeholder="Full Name"/>
        <input type="text" id="inpSection" placeholder="Year & Section (e.g., BS Agri 3A)"/>
      </div>
      <div class="error" id="errStage1" style="display:none;"></div>
      <div class="footer">
        <button id="btnBack">Back</button>
        <button class="primary" id="btnStart">Next</button>
      </div>
    </section>

    <!-- Stage 2: Exam -->
    <section id="stage2" class="hidden">
      <div class="progress">
        <div id="bar" class="bar"></div>
      </div>
      <p id="qtext"></p>
      <div id="choices"></div>
      <div class="error" id="errStage2" style="display:none;"></div>
      <div class="footer">
        <button id="btnPrev">Review</button>
        <div>
          <button id="btnNext" class="primary">Next</button>
          <button id="btnSubmit" class="primary hidden">Submit</button>
        </div>
      </div>
    </section>

    <!-- Stage 3: Result -->
    <section id="stage3" class="hidden">
      <h2>Submission Complete</h2>
      <p><strong id="rName"></strong> (<span id="rSection"></span>)</p>
      <p>Your Score: <strong id="rScore"></strong></p>
      <p class="small">Your complete answer sheet (chosen answers and correct answers) has been saved to the database.</p>
      <p class="error" id="rNote" style="display:none;"></p>
    </section>

  </div>
</div>

<script type="module">
const QUESTIONS = [
  {
    "num": 1,
    "q": "Biocon agents such as compost activators are primarily used to:",
    "A": "Kill all microorganisms in compost",
    "B": "Speed up the decomposition of organic materials",
    "C": "Sterilize soil",
    "D": "Remove all moisture from compost",
    "ans": "B"
  },
  {
    "num": 2,
    "q": "Which microorganism group is MOST commonly involved in compost activation and organic waste fermentation?",
    "A": "Viruses",
    "B": "Lactic acid bacteria and fungi",
    "C": "Helminths",
    "D": "Nematodes",
    "ans": "B"
  },
  {
    "num": 3,
    "q": "Why are fermentation agents added to organic fertilizers?",
    "A": "To make the fertilizer smell good only",
    "B": "To promote controlled microbial activity that stabilizes nutrients",
    "C": "To increase the weight artificially",
    "D": "To remove all nutrients from the compost",
    "ans": "B"
  },
  {
    "num": 4,
    "q": "A farmer wants faster composting of rice straw and animal manure. Which practice best applies the use of biocon agents?",
    "A": "Adding compost activators and maintaining proper moisture and aeration",
    "B": "Burning the straw before composting",
    "C": "Storing the manure in sealed plastic bags",
    "D": "Flooding the compost pit with water",
    "ans": "A"
  },
  {
    "num": 5,
    "q": "Which of the following is an advantage of using biocon or compost activators in smallholder farms?",
    "A": "They permanently sterilize the soil",
    "B": "They shorten composting time and improve nutrient availability",
    "C": "They eliminate the need for any organic waste",
    "D": "They allow farmers to ignore composting conditions",
    "ans": "B"
  },
  {
    "num": 6,
    "q": "Biocon-based fermentation of crop residues and animal manure helps farmers by:",
    "A": "Reducing the organic matter content of the soil",
    "B": "Producing stable, nutrient-rich organic fertilizer with fewer odors",
    "C": "Increasing greenhouse gas emissions",
    "D": "Making soil more compact and less porous",
    "ans": "C"
  },
  {
    "num": 7,
    "q": "A cooperative is evaluating several products labeled as compost “biocon agents.” What is the MOST important factor they should verify?",
    "A": "Color and smell only",
    "B": "Presence of beneficial microorganisms and clear instructions for use",
    "C": "Brand popularity only",
    "D": "Imported origin",
    "ans": "B"
  },
  {
    "num": 8,
    "q": "When using fermentation agents for silage or organic fertilizer, which farmer practice best maintains their effectiveness?",
    "A": "Exposing the agents to direct sunlight for long periods",
    "B": "Storing them according to label instructions and mixing at recommended rates",
    "C": "Mixing them with any chemical pesticide",
    "D": "Applying them only once regardless of conditions",
    "ans": "B"
  },
  {
    "num": 9,
    "q": "From a One Health perspective, why is proper composting and fermentation of organic wastes important?",
    "A": "It focuses only on crop yield",
    "B": "It reduces pathogens and odors, improving environmental and community health",
    "C": "It increases uncontrolled pest populations",
    "D": "It eliminates the need for hygiene in handling wastes",
    "ans": "B"
  },
  {
    "num": 10,
    "q": "An agricultural extension worker promotes the use of biocon agents instead of open-field burning of residues. Which benefit BEST supports this recommendation?",
    "A": "Open burning always increases soil fertility",
    "B": "Biocon-assisted composting reduces air pollution and recycles nutrients back to the field",
    "C": "Biocon agents permanently eliminate all weeds",
    "D": "Biocon use reduces the need for any farm labor",
    "ans": "C"
  },
  {
    "num": 11,
    "q": "Biopharming refers to:",
    "A": "Traditional crop rotation for soil fertility",
    "B": "Using farm animals to process household waste",
    "C": "Producing pharmaceutical or industrial compounds using genetically modified plants or animals",
    "D": "Manual seed selection by farmers",
    "ans": "B"
  },
  {
    "num": 12,
    "q": "Which example BEST illustrates biopharming?",
    "A": "Purely organic rice farming",
    "B": "Maize engineered to produce edible vaccines against a specific disease",
    "C": "Traditional herbal medicine use",
    "D": "Using compost as fertilizer",
    "ans": "A"
  },
  {
    "num": 13,
    "q": "One major concern about biopharming in open-field conditions is:",
    "A": "Lack of any effect on surrounding crops",
    "B": "Potential gene flow or mixing with food/feed crops, causing unintended exposure",
    "C": "Increased soil erosion",
    "D": "Immediate extinction of wild species",
    "ans": "B"
  },
  {
    "num": 14,
    "q": "Which BEST describes a key regulatory requirement for biopharming projects?",
    "A": "No regulation is required",
    "B": "Strict biosafety evaluation, containment measures, and monitoring to prevent unintended exposure",
    "C": "Only voluntary guidelines without any formal approval",
    "D": "Approval only from international agencies, not from local authorities",
    "ans": "B"
  },
  {
    "num": 15,
    "q": "From a farmer and consumer perspective, what is an important ethical question regarding biopharming?",
    "A": "Whether compost is allowed in the farm",
    "B": "How to ensure that pharmaceuticals produced in crops do not accidentally enter the regular food chain",
    "C": "Whether to irrigate crops or not",
    "D": "How to stop all innovation in agriculture",
    "ans": "B"
  },
  {
    "num": 16,
    "q": "\"Fake seeds\" in agriculture usually refer to:",
    "A": "Seeds that are larger than normal",
    "B": "Seeds with falsified labels or poor genetic and physical quality sold as branded seeds",
    "C": "Any seed from farmers’ fields",
    "D": "Seeds with high germination",
    "ans": "B"
  },
  {
    "num": 17,
    "q": "Which is a common consequence of fake or substandard seeds on farmers?",
    "A": "Higher and more reliable yields",
    "B": "Crop failure, reduced yield, and financial loss",
    "C": "Guaranteed disease resistance",
    "D": "Improved market prices",
    "ans": "B"
  },
  {
    "num": 18,
    "q": "Which measure can help protect farmers from fake seeds?",
    "A": "Buying unlabeled seeds from unknown vendors",
    "B": "Purchasing seeds only from certified dealers and checking official labels",
    "C": "Avoiding any record-keeping",
    "D": "Ignoring expiration dates and quality seals",
    "ans": "B"
  },
  {
    "num": 19,
    "q": "At the policy level, how can governments reduce the occurrence of fake seeds in the market?",
    "A": "By not regulating seed quality at all",
    "B": "By strengthening seed certification, market surveillance, and penalties for fraud",
    "C": "By banning all private seed companies",
    "D": "By removing all inspection systems",
    "ans": "B"
  },
  {
    "num": 20,
    "q": "From a One Health and food security perspective, the widespread circulation of fake seeds is a concern because:",
    "A": "It always increases biodiversity",
    "B": "It threatens harvest reliability, farmer income, and community food supply",
    "C": "It only affects ornamental plants",
    "D": "It only affects urban consumers",
    "ans": "B"
  },
  {
    "num": 21,
    "q": "Vaccines used in livestock production primarily aim to:",
    "A": "Decrease all animal growth",
    "B": "Prevent or reduce the severity of infectious diseases, improving animal health and productivity",
    "C": "Eliminate the need for any hygiene",
    "D": "Replace all types of feed",
    "ans": "B"
  },
  {
    "num": 22,
    "q": "Which is an example of a benefit of vaccination from a public health perspective?",
    "A": "Increasing the risk of zoonotic diseases",
    "B": "Reducing transmission of zoonotic diseases from animals to humans",
    "C": "Guaranteeing overuse of antibiotics",
    "D": "Eliminating the need for surveillance",
    "ans": "B"
  },
  {
    "num": 23,
    "q": "Cold chain management in vaccine distribution is important because:",
    "A": "Vaccines are always heat stable",
    "B": "Improper temperature can reduce vaccine effectiveness or make them unsafe",
    "C": "It only affects the label color",
    "D": "It is done only for marketing purposes",
    "ans": "B"
  },
  {
    "num": 24,
    "q": "In agricultural communities, misleading claims about vaccines (e.g., that they cause the disease they prevent) can lead to:",
    "A": "Improved vaccination rates",
    "B": "Vaccine hesitancy and disease outbreaks",
    "C": "Stronger trust in science",
    "D": "Uniform adoption of best practices",
    "ans": "B"
  },
  {
    "num": 25,
    "q": "From a sustainable livestock production perspective, integrating proper vaccination with good nutrition and housing can:",
    "A": "Reduce overall productivity",
    "B": "Improve animal welfare, decrease mortality, and stabilize farmer income",
    "C": "Make disease surveillance unnecessary",
    "D": "Eliminate the need for trained veterinarians",
    "ans": "B"
  },
  {
    "num": 26,
    "q": "Artificial insemination (AI) in animals is best described as:",
    "A": "Natural mating in a pasture",
    "B": "Manual collection of semen and its controlled deposition into the female reproductive tract",
    "C": "Cloning of animals in the lab",
    "D": "Surgical removal of ovaries",
    "ans": "B"
  },
  {
    "num": 27,
    "q": "Multiple Ovulation and Embryo Transfer (MOET) allows breeders to:",
    "A": "Reduce the genetic diversity of herds only",
    "B": "Obtain more offspring from genetically superior females in a shorter time",
    "C": "Stop all natural reproduction",
    "D": "Avoid any record-keeping",
    "ans": "B"
  },
  {
    "num": 28,
    "q": "Which is a primary advantage of AI and MOET in improving animal genetics?",
    "A": "Random mating without selection",
    "B": "Faster dissemination of desirable traits such as high milk yield or growth rate",
    "C": "Elimination of all genetic variation",
    "D": "Guaranteed absence of diseases in offspring",
    "ans": "B"
  },
  {
    "num": 29,
    "q": "A key ethical and practical concern with AI/MOET in smallholder settings is:",
    "A": "Too little genetic improvement",
    "B": "Possible loss of locally adapted breeds if only a few high-performing lines are used",
    "C": "Lack of any need for training",
    "D": "Total independence from veterinary services",
    "ans": "B"
  },
  {
    "num": 30,
    "q": "From a One Health viewpoint, responsible use of AI and MOET includes:",
    "A": "Ignoring animal welfare",
    "B": "Considering animal welfare, genetic diversity, and long-term resilience of production systems",
    "C": "Focusing only on short-term milk yield",
    "D": "Completely avoiding any health monitoring",
    "ans": "B"
  },
  {
    "num": 31,
    "q": "Probiotics in animal nutrition refer to:",
    "A": "Any form of antibiotic used in feed",
    "B": "Live beneficial microorganisms given to improve gut health and overall performance",
    "C": "Synthetic growth hormones",
    "D": "Inert feed additives with no biological effect",
    "ans": "B"
  },
  {
    "num": 32,
    "q": "Which is a commonly reported benefit of probiotics in livestock?",
    "A": "Reduced feed efficiency",
    "B": "Improved digestion, better feed conversion, and sometimes reduced diarrhea",
    "C": "Increased toxin levels in the gut",
    "D": "Complete replacement of clean water",
    "ans": "B"
  },
  {
    "num": 33,
    "q": "Probiotics and good gut health can contribute to reduced antibiotic use because:",
    "A": "They cause more infections",
    "B": "They support the animal’s natural defenses, possibly reducing the frequency of infections",
    "C": "They directly eliminate the need for hygiene",
    "D": "They permanently sterilize the intestines",
    "ans": "B"
  },
  {
    "num": 34,
    "q": "When farmers use probiotics, it is important that they:",
    "A": "Store them in any condition",
    "B": "Follow product instructions, including storage and mixing rates, to maintain viability of microorganisms",
    "C": "Mix them with any chemical pesticide in feed",
    "D": "Add them only once in the animal’s life",
    "ans": "B"
  },
  {
    "num": 35,
    "q": "From a One Health perspective, promoting probiotics and good management in place of routine antibiotic growth promoters helps by:",
    "A": "Increasing antimicrobial resistance",
    "B": "Potentially reducing selection pressure for antimicrobial-resistant bacteria",
    "C": "Eliminating the need for disease monitoring",
    "D": "Guaranteeing that no animal will ever get sick",
    "ans": "B"
  },
  {
    "num": 36,
    "q": "Which statement BEST reflects the idea of \"biotechnology products nearing commercialization\"?",
    "A": "All biotech products are still in basic research",
    "B": "Some products, such as GM crops with improved traits, gene-based vaccines, or biopharmaceuticals, are close to or already entering the market",
    "C": "No biotech product is allowed anywhere in the world",
    "D": "Only traditional technologies are relevant for modern agriculture",
    "ans": "B"
  },
  {
    "num": 37,
    "q": "A key factor determining whether a new biotech product can be commercialized is:",
    "A": "Its popularity on social media only",
    "B": "Compliance with biosafety, efficacy, ethical, and regulatory requirements",
    "C": "Lack of any regulatory review",
    "D": "Only its price in the market",
    "ans": "B"
  },
  {
    "num": 38,
    "q": "Consider a genetically modified crop that is drought tolerant and pest resistant. From a sustainability perspective, which potential advantage is MOST relevant?",
    "A": "It always requires more pesticides",
    "B": "It may reduce input use and crop losses, contributing to more stable yields under stress conditions",
    "C": "It automatically causes soil erosion",
    "D": "It eliminates the need for training farmers",
    "ans": "B"
  },
  {
    "num": 39,
    "q": "In discussing the future of biotechnology, which aspect is important for ensuring public trust?",
    "A": "Keeping all information confidential",
    "B": "Transparent risk assessment, stakeholder engagement, and clear communication of benefits and risks",
    "C": "Excluding farmers and consumers from discussions",
    "D": "Ignoring local cultural and ethical concerns",
    "ans": "B"
  },
  {
    "num": 40,
    "q": "Biotechnology in a sustainable future is BEST described as:",
    "A": "A single solution to all agricultural problems",
    "B": "One of several tools that, when used responsibly with traditional practices, can help address food security, health, and environmental challenges",
    "C": "A technology that replaces all local knowledge",
    "D": "A replacement for good governance and policy",
    "ans": "B"
  },
  {
    "num": 41,
    "q": "Why are regulations essential in the use of agricultural biotechnology?",
    "A": "To stop all innovation",
    "B": "To ensure that biotech products are safe for human, animal, and environmental health before and after release",
    "C": "To make approval faster regardless of safety",
    "D": "To benefit only a few companies",
    "ans": "B"
  },
  {
    "num": 42,
    "q": "In many countries, which body typically oversees biosafety assessments of genetically modified crops?",
    "A": "Only private seed companies",
    "B": "Relevant government biosafety or regulatory agencies and committees",
    "C": "Supermarkets",
    "D": "Farmer associations alone",
    "ans": "B"
  },
  {
    "num": 43,
    "q": "From a One Health perspective, regulation of biotechnology should consider:",
    "A": "Human health only",
    "B": "Human, animal, and environmental health together, including socio-economic impacts",
    "C": "Economic cost only",
    "D": "Lab convenience only",
    "ans": "B"
  },
  {
    "num": 44,
    "q": "What is one potential risk if biotechnology products are introduced without adequate regulation and monitoring?",
    "A": "Guaranteed long-term sustainability",
    "B": "Unintended harm to ecosystems, food safety issues, or loss of public trust",
    "C": "Improved risk communication",
    "D": "Perfect knowledge among all stakeholders",
    "ans": "B"
  },
  {
    "num": 45,
    "q": "Stakeholder participation in biotechnology regulation is important because:",
    "A": "It slows down all processes for no reason",
    "B": "It allows different groups (farmers, consumers, scientists, policymakers) to share concerns and expectations, leading to more acceptable decisions",
    "C": "It removes the need for scientific evidence",
    "D": "It focuses only on company profits",
    "ans": "B"
  },
  {
    "num": 46,
    "q": "A farmer group is considering adopting a new biotech crop. Which combination of actions BEST supports responsible decision-making?",
    "A": "Relying only on rumors",
    "B": "Consulting extension workers, checking official regulatory approvals, and comparing performance with existing varieties",
    "C": "Ignoring local conditions",
    "D": "Using the crop without any information",
    "ans": "B"
  },
  {
    "num": 47,
    "q": "From a long-term sustainability standpoint, why is it important to integrate biotechnology with other practices such as agroecology and good management?",
    "A": "Biotechnology alone is always sufficient",
    "B": "Combining different approaches can maximize benefits while reducing risks and dependency on a single solution",
    "C": "Other practices always conflict with biotechnology",
    "D": "It eliminates the need for regulations",
    "ans": "B"
  },
  {
    "num": 48,
    "q": "Farmers and communities sometimes worry about losing control over seeds and technologies. What is one way to address this concern in the context of biotechnology?",
    "A": "Limiting any information to farmers",
    "B": "Developing policies that protect farmers’ rights, encourage local breeding, and ensure fair access to technology",
    "C": "Eliminating all local varieties",
    "D": "Banning farmers from saving seeds",
    "ans": "B"
  },
  {
    "num": 49,
    "q": "Considering One Health and sustainability, the MOST appropriate view of agricultural biotechnology is that it:",
    "A": "Should replace all other technologies",
    "B": "Should be evaluated case by case, integrated with other practices, and governed by strong biosafety and ethical frameworks",
    "C": "Can be used without any regulation",
    "D": "Has no role in modern agriculture",
    "ans": "B"
  },
  {
    "num": 50,
    "q": "A country invests in regulations, training, and infrastructure to support both modern biotechnology and traditional practices. From a sustainability perspective, how should this strategy be evaluated?",
    "A": "Wasteful, since only one technology is needed",
    "B": "Positive, because it balances innovation, safety, and inclusiveness for different types of farmers",
    "C": "Harmful, as it limits choices",
    "D": "Neutral, with no real impact (OK)",
    "ans": "B"
  }
];

// ==== Firebase imports and setup ====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getFirestore, collection, getDocs, doc, setDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-idZOq8h9sVttNdzXE2t8FMoYI_snq7g",
  authDomain: "kuya-quiz-100.firebaseapp.com",
  projectId: "kuya-quiz-100",
  storageBucket: "kuya-quiz-100.appspot.com",
  messagingSenderId: "74623975270",
  appId: "1:74623975270:web:dec2b21dbee017292952a7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
try {
  await signInAnonymously(auth);
} catch(e) {
  console.warn("Anonymous auth failed:", e);
}

// ==== Exam constants ====
const EXAM_DOC_ID = "KzRzubb5df1TV1gL2RuF";
const COURSE_TITLE = document.title;
const EXAM_SECONDS = 60 * 60;
// JS Date: year, monthIndex (0=Jan), day, hour, min, sec
const CLOSING_TIME = new Date(2025, 10, 21, 23, 59, 59); // 21 Nov 2025, 11:59:59 PM

// ==== DOM references ====
const stage0 = document.getElementById("stage0");
const stage1 = document.getElementById("stage1");
const stage2 = document.getElementById("stage2");
const stage3 = document.getElementById("stage3");

const errStage0 = document.getElementById("errStage0");
const errStage1 = document.getElementById("errStage1");
const errStage2 = document.getElementById("errStage2");

const btnUnderstand = document.getElementById("btnUnderstand");
const btnBack = document.getElementById("btnBack");
const btnStart = document.getElementById("btnStart");
const btnPrev = document.getElementById("btnPrev");
const btnNext = document.getElementById("btnNext");
const btnSubmit = document.getElementById("btnSubmit");

const inpName = document.getElementById("inpName");
const inpSection = document.getElementById("inpSection");

const qtext = document.getElementById("qtext");
const choicesEl = document.getElementById("choices");
const barEl = document.getElementById("bar");

const metaRow = document.getElementById("meta");
const pillName = document.getElementById("pillName");
const pillSection = document.getElementById("pillSection");
const pillTimer = document.getElementById("pillTimer");
const pillCount = document.getElementById("pillCount");

const rName = document.getElementById("rName");
const rSection = document.getElementById("rSection");
const rScore = document.getElementById("rScore");
const rNote = document.getElementById("rNote");

// ==== State ====
let currentIndex = 0;
let selectedAnswers = new Array(QUESTIONS.length).fill(null);
let secondsLeft = EXAM_SECONDS;
let timerId = null;
let studentId = null;
let studentName = "";
let studentSection = "";
let submitting = false;

// ==== Helper functions ====
function isClosed() {
  const now = new Date();
  return now > CLOSING_TIME;
}

function showErr(el, msg) {
  el.textContent = msg;
  el.style.display = msg ? "block" : "none";
}

function switchStage(stage) {
  stage0.classList.add("hidden");
  stage1.classList.add("hidden");
  stage2.classList.add("hidden");
  stage3.classList.add("hidden");
  stage.classList.remove("hidden");
}

function renderQuestion() {
  const q = QUESTIONS[currentIndex];
  qtext.textContent = q.q;
  choicesEl.innerHTML = "";
  const letters = ["A","B","C","D"];
  letters.forEach(l => {
    const checked = selectedAnswers[currentIndex] === l ? " checked" : "";
    const html = `
      <label class="choice">
        <input type="radio" name="opt" value="${l}"${checked}>
        <div><b>${l}.</b> ${q[l]}</div>
      </label>`;
    choicesEl.insertAdjacentHTML("beforeend", html);
  });
  pillCount.textContent = "Q: " + (currentIndex + 1) + " / " + QUESTIONS.length;
  if (QUESTIONS.length > 1) {
    const pct = (currentIndex / (QUESTIONS.length - 1)) * 100;
    barEl.style.width = pct + "%";
  } else {
    barEl.style.width = "0%";
  }
  btnPrev.disabled = (currentIndex === 0);
  if (currentIndex === QUESTIONS.length - 1) {
    btnNext.classList.add("hidden");
    btnSubmit.classList.remove("hidden");
  } else {
    btnNext.classList.remove("hidden");
    btnSubmit.classList.add("hidden");
  }
  showErr(errStage2, "");
}

function getSelectedValue() {
  const sel = choicesEl.querySelector("input[name='opt']:checked");
  return sel ? sel.value : null;
}

function startTimer() {
  secondsLeft = EXAM_SECONDS;
  pillTimer.textContent = "Time: 60:00";
  if (timerId) {
    clearInterval(timerId);
  }
  timerId = setInterval(() => {
    secondsLeft -= 1;
    if (secondsLeft < 0) secondsLeft = 0;
    const m = Math.floor(secondsLeft / 60);
    const s = secondsLeft % 60;
    pillTimer.textContent = "Time: " +
      String(m).padStart(2,"0") + ":" + String(s).padStart(2,"0");
    if (secondsLeft <= 0) {
      clearInterval(timerId);
      timerId = null;
      autoSubmit();
    }
  }, 1000);
}

async function getAttemptCountForStudent(id) {
  try {
    const attemptsCol = collection(
      db,
      "finals-exam", EXAM_DOC_ID,
      "submissions", id,
      "attempts"
    );
    const snap = await getDocs(attemptsCol);
    return snap.size;
  } catch (e) {
    console.warn("Attempt count check failed:", e);
    // If attempt check fails due to permissions, treat as 0 attempts
    return 0;
  }
}

function computeScore() {
  let score = 0;
  for (let i = 0; i < QUESTIONS.length; i++) {
    const q = QUESTIONS[i];
    if (selectedAnswers[i] && selectedAnswers[i] === q.ans) {
      score += 1;
    }
  }
  return score;
}

function buildAnswerSheet() {
  const out = [];
  for (let i = 0; i < QUESTIONS.length; i++) {
    const q = QUESTIONS[i];
    out.push({
      questionNumber: q.num,
      question: q.q,
      options: { A: q.A, B: q.B, C: q.C, D: q.D },
      correctAnswer: q.ans,
      chosenAnswer: selectedAnswers[i],
      isCorrect: selectedAnswers[i] === q.ans
    });
  }
  return out;
}

// ==== Button handlers ====
btnUnderstand.addEventListener("click", () => {
  if (isClosed()) {
    showErr(errStage0, "This exam is already closed. Deadline was 11:59:59 PM on 21 November 2025.");
    return;
  }
  showErr(errStage0, "");
  switchStage(stage1);
});

btnBack.addEventListener("click", () => {
  switchStage(stage0);
});

btnStart.addEventListener("click", async () => {
  if (isClosed()) {
    showErr(errStage1, "This exam is already closed. Deadline was 11:59:59 PM on 21 November 2025.");
    return;
  }
  const nm = inpName.value.trim();
  const sec = inpSection.value.trim();
  if (!nm) {
    showErr(errStage1, "Please enter your full name.");
    return;
  }
  if (!sec) {
    showErr(errStage1, "Please enter your Year & Section.");
    return;
  }
  showErr(errStage1, "");

  studentName = nm;
  studentSection = sec;

  let raw = nm + "|||" + sec + "|||" + COURSE_TITLE;
  let base;
  try {
    base = btoa(unescape(encodeURIComponent(raw)));
  } catch (e) {
    base = raw;
  }
  studentId = base.replace(/[^A-Za-z0-9]/g, "").slice(0,80) || "student";

  const attemptCount = await getAttemptCountForStudent(studentId);
  if (attemptCount >= 2) {
    showErr(errStage1, "You have already used your 2 allowed attempts. Further attempts are blocked.");
    return;
  }

  metaRow.classList.remove("hidden");
  pillName.textContent = "Name: " + studentName;
  pillSection.textContent = "Year/Section: " + studentSection;
  pillCount.textContent = "Q: 1 / " + QUESTIONS.length;

  currentIndex = 0;
  selectedAnswers = new Array(QUESTIONS.length).fill(null);

  switchStage(stage2);
  renderQuestion();
  startTimer();
});

btnNext.addEventListener("click", () => {
  const sel = getSelectedValue();
  if (!sel) {
    showErr(errStage2, "Please choose an answer before proceeding.");
    return;
  }
  selectedAnswers[currentIndex] = sel;
  if (currentIndex < QUESTIONS.length - 1) {
    currentIndex += 1;
    renderQuestion();
  }
});

btnPrev.addEventListener("click", () => {
  const sel = getSelectedValue();
  if (sel) {
    selectedAnswers[currentIndex] = sel;
  }
  if (currentIndex > 0) {
    currentIndex -= 1;
    renderQuestion();
  }
});

btnSubmit.addEventListener("click", () => {
  const sel = getSelectedValue();
  if (!sel) {
    showErr(errStage2, "Please choose an answer before submitting.");
    return;
  }
  selectedAnswers[currentIndex] = sel;
  submitExam(false);
});

// ==== Submission logic ====
async function submitExam(autoSubmitted) {
  if (submitting) return;
  submitting = true;
  btnSubmit.disabled = true;
  btnNext.disabled = true;
  btnPrev.disabled = true;
  showErr(errStage2, "");
  if (timerId) {
    clearInterval(timerId);
    timerId = null;
  }

  const score = computeScore();
  const answerSheet = buildAnswerSheet();

  const payload = {
    Course: COURSE_TITLE,
    submissionDate: serverTimestamp(),
    Score: score,
    Name: studentName,
    secondsRemaining: secondsLeft,
    section: studentSection,
    answers: answerSheet,
    autoSubmitted: !!autoSubmitted
  };

  try {
    const attemptsCol = collection(
      db,
      "finals-exam", EXAM_DOC_ID,
      "submissions", studentId,
      "attempts"
    );
    const snap = await getDocs(attemptsCol);
    const attemptNum = snap.size + 1;
    const ref = doc(
      db,
      "finals-exam", EXAM_DOC_ID,
      "submissions", studentId,
      "attempts",
      "attempt" + attemptNum
    );
    await setDoc(ref, payload);

    alert("your exam has been submitted");
    rName.textContent = studentName;
    rSection.textContent = studentSection;
    rScore.textContent = score + " / " + QUESTIONS.length;
    switchStage(stage3);
  } catch (e) {
    console.error("Submission failed:", e);
    alert("submission fail, please try again");
    btnSubmit.disabled = false;
    btnNext.disabled = false;
    btnPrev.disabled = (currentIndex === 0);
    if (!timerId && secondsLeft > 0) {
      startTimer();
    }
    submitting = false;
    return;
  }

  submitting = false;
}

async function autoSubmit() {
  if (submitting) return;
  const sel = getSelectedValue();
  if (sel) {
    selectedAnswers[currentIndex] = sel;
  }
  await submitExam(true);
}

// Initial meta text
pillTimer.textContent = "Time: 60:00";
pillCount.textContent = "Q: — / " + QUESTIONS.length;
</script>
</body>
</html>


