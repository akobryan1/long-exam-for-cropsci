<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Crop Science Long Exam</title>
<style>
  @media (max-width: 600px) {
    body { font-size: 15px; }
    .wrap { padding: 16px; }
    .qtext { font-size: 16px; }
    .choice { padding: 10px; }
    button { width: 100%; }
    .footer { flex-direction: column; align-items: stretch; }
  }

  :root{
    --bg:#0f172a; --card:#111827; --muted:#64748b; --text:#e5e7eb; --accent:#22c55e; --warn:#f59e0b; --bad:#ef4444; --good:#10b981;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(180deg,#0b1022,#0f172a);color:var(--text)}
  .wrap{max-width:960px;margin:0 auto;padding:24px}
  .card{background:linear-gradient(180deg,#0b1220,#0d1426);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  header{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:16px 20px;border-bottom:1px solid #1f2937}
  header .meta{display:flex;gap:16px;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;background:#111827;color:#cbd5e1;border:1px solid #1f2937;font-size:12px}
  .content{padding:20px}
  h1{margin:0;font-size:18px;color:#e2e8f0}
  h2{margin:0 0 8px 0;font-size:16px;color:#e2e8f0}
  .name-stage, .quiz-stage, .result-stage{display:none}
  .active{display:block}
  .field{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
  input[type="text"]{padding:12px 14px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb;flex:1;min-width:220px}
  button{padding:12px 16px;border:1px solid #263042;border-radius:12px;background:#0b1326;color:#e5e7eb;cursor:pointer}
  button.primary{background:linear-gradient(180deg,#126d3a,#0d5a30);border-color:#144b2e}
  button.warn{background:linear-gradient(180deg,#8a580c,#6f460a);border-color:#6b3b06}
  button:hover{filter:brightness(1.08)}
  .qtext{font-size:18px;line-height:1.5;margin-bottom:16px}
  .choices{display:grid;gap:10px}
  .choice{display:flex;gap:10px;align-items:flex-start;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px}
  .choice input{margin-top:3px}
  .footer{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:16px}
  .progress{height:8px;background:#0f172a;border:1px solid #1f2937;border-radius:999px;overflow:hidden}
  .bar{height:100%;background:linear-gradient(90deg,#22c55e,#16a34a)}
  .toast{position:fixed;right:18px;bottom:18px;background:#111827;border:1px solid #334155;border-radius:12px;padding:12px 14px;color:#e5e7eb;opacity:0;transform:translateY(8px);transition:.25s;z-index:9999}
  .toast.show{opacity:1;transform:translateY(0)}
  .muted{color:#94a3b8}
  .small{font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>Crop Science Long Exam</h1>
      <div class="meta">
        <span class="pill" id="who">Name: â€”</span>
        <span class="pill" id="ys">Year/Section: â€”</span>
        <span class="pill" id="timer">Time: 60:00</span>
        <span class="pill" id="counter">Q: â€” / 100</span>
        <span class="pill" id="penalties">Tab switches: 0</span>
        <span class="pill" id="deduct">Penalty: 0</span>
      </div>
    </header>
    <div class="content">
      <!-- Stage: Name -->
      <section class="name-stage active" id="stageName">
        <h2>Enter your name and year/section to begin</h2>
        <div class="field">
          <input type="text" id="studentName" placeholder="Full name (e.g., Juan Dela Cruz)" />
          <input type="text" id="yearSection" placeholder="Year & Section (e.g., BS Agri 2A)" />
          <button class="primary" id="btnStart">Start Quiz</button>
        </div>
        <p class="muted small">Once you start, youâ€™ll have <b>1 hour</b>. Questions are randomized and unnumbered. Switching tabs deducts <b>10 points</b> each time.</p>
      </section>

      <!-- Stage: Quiz -->
      <section class="quiz-stage" id="stageQuiz">
        <div class="progress" aria-hidden="true"><div class="bar" id="bar" style="width:0%"></div></div>
        <p class="qtext" id="qtext"></p>
        <div class="choices" id="choices"></div>
        <div class="footer">
          <button id="btnPrev">Review</button>
          <div>
            <button id="btnNext" class="primary">Next</button>
          </div>
        </div>
      </section>

      <!-- Stage: Results (no answer sheet shown to students) -->
      <section class="result-stage" id="stageResult">
        <h2>Submission Complete âœ…</h2>
        <p><b id="resName"></b> (<span id="resYS"></span>), your quiz has been submitted.</p>
        <p>Raw Score: <b id="resRaw"></b> / 100<br>
           Penalties (tab switches Ã— 10): <b id="resPenalty"></b><br>
           Final Score: <b id="resFinal"></b> / 100</p>
        <p class="muted small">Your detailed answer sheet was saved securely and is not displayed here.</p>
      </section>
    </div>
  </div>
</div>

<div class="toast" id="toast">Please choose an answer before proceeding.</div>

<!-- Firebase (modules) + Quiz logic -->
<script type="module">
  // ===========================
  // ðŸ”§ FIREBASE SETUP
  // ===========================
  const firebaseConfig = {
    apiKey: "AIzaSyB-idZOq8h9sVttNdzXE2t8FMoYI_snq7g",
    authDomain: "kuya-quiz-100.firebaseapp.com",
    projectId: "kuya-quiz-100",
    storageBucket: "kuya-quiz-100.appspot.com",
    messagingSenderId: "74623975270",
    appId: "1:74623975270:web:dec2b21dbee017292952a7"
  };

  const canInitFirebase = Object.values(firebaseConfig).every(v => typeof v === 'string' && !v.includes('REPLACE_ME'));
  let app, db, addDoc, collection, serverTimestamp, signInAnonymously, getAuth;
  if (canInitFirebase) {
    const firebase = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js");
    const firestore = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
    const authmod = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
    app = firebase.initializeApp(firebaseConfig);
    db  = firestore.getFirestore(app);
    addDoc = firestore.addDoc;
    collection = firestore.collection;
    serverTimestamp = firestore.serverTimestamp;
    getAuth = authmod.getAuth;
    signInAnonymously = authmod.signInAnonymously;
    try { await signInAnonymously(getAuth(app)); } catch(e) { console.warn("Anon auth failed:", e); }
  }

  // ===========================
  // QUESTIONS (from cropsci long exam.odt)
  // ===========================
  const QUESTIONS = [
  {id:1,q:"What is the scientific study of crops and the soils in which they grow called?",A:"Horticulture",B:"Agronomy",C:"Botany",D:"Soil Science",ans:"B"},
  {id:2,q:"Which crop is primarily grown for its oil-rich seeds?",A:"Rice",B:"Soybean",C:"Wheat",D:"Maize",ans:"B"},
  {id:3,q:"Which part of the plant is mainly responsible for photosynthesis?",A:"Root",B:"Stem",C:"Leaf",D:"Flower",ans:"C"},
  {id:4,q:"Which macronutrient is essential for chlorophyll formation?",A:"Phosphorus",B:"Nitrogen",C:"Potassium",D:"Calcium",ans:"B"},
  {id:5,q:"Which of the following is an example of a cereal crop?",A:"Tomato",B:"Rice",C:"Soybean",D:"Sugarcane",ans:"B"},
  {id:6,q:"Which crop is known as a legume?",A:"Corn",B:"Mungbean",C:"Cassava",D:"Coconut",ans:"B"},
  {id:7,q:"Which of the following crops is propagated vegetatively?",A:"Rice",B:"Corn",C:"Cassava",D:"Wheat",ans:"C"},
  {id:8,q:"Which of the following is NOT a factor affecting crop growth?",A:"Soil fertility",B:"Climate",C:"Pest infestation",D:"Computer hardware",ans:"D"},
  {id:9,q:"The process of transferring pollen from anther to stigma is called:",A:"Germination",B:"Pollination",C:"Fertilization",D:"Propagation",ans:"B"},
  {id:10,q:"Which of the following crops belongs to the grass family (Poaceae)?",A:"Rice",B:"Mungbean",C:"Peanut",D:"Coconut",ans:"A"},
  {id:11,q:"What is the term for growing crops and raising livestock in the same area?",A:"Monocropping",B:"Intercropping",C:"Mixed farming",D:"Crop rotation",ans:"C"},
  {id:12,q:"Which of the following crops is classified as a root crop?",A:"Cassava",B:"Rice",C:"Corn",D:"Coconut",ans:"A"},
  {id:13,q:"Which of the following is an abiotic factor affecting crop growth?",A:"Insects",B:"Fungi",C:"Temperature",D:"Weeds",ans:"C"},
  {id:14,q:"Which element promotes root growth and fruit formation?",A:"Nitrogen",B:"Phosphorus",C:"Iron",D:"Magnesium",ans:"B"},
  {id:15,q:"Which of the following is an example of a pulse crop?",A:"Corn",B:"Soybean",C:"Wheat",D:"Sugarcane",ans:"B"},
  {id:16,q:"Crop rotation helps prevent:",A:"Soil erosion",B:"Pest and disease buildup",C:"Rainfall",D:"Sunlight",ans:"B"},
  {id:17,q:"The primary purpose of tillage is to:",A:"Harden the soil",B:"Prepare the land for planting",C:"Remove fertilizer",D:"Reduce soil fertility",ans:"B"},
  {id:18,q:"Which of the following crops is known as a fiber crop?",A:"Rice",B:"Cotton",C:"Corn",D:"Soybean",ans:"B"},
  {id:19,q:"What is the main function of stomata in plants?",A:"Absorb nutrients",B:"Transport water",C:"Gas exchange",D:"Anchor the plant",ans:"C"},
  {id:20,q:"The transfer of genetic material from one organism to another to produce improved varieties is called:",A:"Mutation",B:"Hybridization",C:"Selection",D:"Grafting",ans:"B"},
  {id:21,q:"Which of the following is an organic fertilizer?",A:"Urea",B:"Compost",C:"Ammonium sulfate",D:"Potassium chloride",ans:"B"},
  {id:22,q:"The process by which seeds develop into seedlings is known as:",A:"Photosynthesis",B:"Germination",C:"Fertilization",D:"Transpiration",ans:"B"},
  {id:23,q:"What do we call a plant that completes its life cycle in one year?",A:"Perennial",B:"Biennial",C:"Annual",D:"Deciduous",ans:"C"},
  {id:24,q:"Which of the following crops is used as a sugar source?",A:"Rice",B:"Corn",C:"Sugarcane",D:"Soybean",ans:"C"},
  {id:25,q:"The method of planting two or more crops in the same area at the same time is called:",A:"Monocropping",B:"Intercropping",C:"Crop rotation",D:"Fallowing",ans:"B"},
  {id:26,q:"Which crop is known as the 'Queen of Cereals'?",A:"Rice",B:"Corn",C:"Wheat",D:"Barley",ans:"A"},
  {id:27,q:"Which of the following environmental factors most directly influences photosynthesis?",A:"Soil type",B:"Sunlight",C:"Wind",D:"Rainfall",ans:"B"},
  {id:28,q:"Which of the following is the best method to control soil erosion?",A:"Plowing up and down slopes",B:"Contour farming",C:"Excessive tillage",D:"Burning crop residues",ans:"B"},
  {id:29,q:"In crop production, what does IPM stand for?",A:"Integrated Pest Management",B:"Internal Plant Mechanism",C:"Inorganic Plant Minerals",D:"Integrated Plant Metabolism",ans:"A"},
  {id:30,q:"Which plant hormone is responsible for cell elongation?",A:"Cytokinin",B:"Gibberellin",C:"Auxin",D:"Ethylene",ans:"C"},
  {id:31,q:"Which part of the seed provides food for the embryo?",A:"Seed coat",B:"Endosperm",C:"Radicle",D:"Plumule",ans:"B"},
  {id:32,q:"Which is the most important factor for germination?",A:"Water",B:"Light",C:"Wind",D:"Carbon dioxide",ans:"A"},
  {id:33,q:"The conversion of atmospheric nitrogen into usable forms by microorganisms is called:",A:"Nitrification",B:"Nitrogen fixation",C:"Ammonification",D:"Denitrification",ans:"B"},
  {id:34,q:"The process of water loss through leaves is known as:",A:"Evaporation",B:"Transpiration",C:"Respiration",D:"Condensation",ans:"B"},
  {id:35,q:"What is the primary source of energy for photosynthesis?",A:"Water",B:"Sunlight",C:"Carbon dioxide",D:"Soil nutrients",ans:"B"},
  {id:36,q:"Which of the following crops is drought-tolerant?",A:"Rice",B:"Sorghum",C:"Cabbage",D:"Lettuce",ans:"B"},
  {id:37,q:"The edible part of the rice grain is the:",A:"Bran",B:"Endosperm",C:"Germ",D:"Hull",ans:"B"},
  {id:38,q:"Which of the following is an example of a tuber crop?",A:"Corn",B:"Potato",C:"Soybean",D:"Rice",ans:"B"},
  {id:39,q:"Which component of soil affects its water-holding capacity the most?",A:"Texture",B:"Color",C:"pH",D:"Salinity",ans:"A"},
  {id:40,q:"What is the function of legumes in crop rotation?",A:"Reduce biodiversity",B:"Increase nitrogen in soil",C:"Absorb phosphorus",D:"Increase acidity",ans:"B"},
  {id:41,q:"Which element helps in the development of strong stems?",A:"Calcium",B:"Iron",C:"Nitrogen",D:"Sulfur",ans:"A"},
  {id:42,q:"Which of the following is a micronutrient?",A:"Phosphorus",B:"Magnesium",C:"Iron",D:"Potassium",ans:"C"},
  {id:43,q:"Which practice helps improve soil organic matter?",A:"Burning residues",B:"Continuous cropping",C:"Adding compost",D:"Overtillage",ans:"C"},
  {id:44,q:"In crop breeding, selecting plants with desirable traits is known as:",A:"Mutation",B:"Selection",C:"Inoculation",D:"Sterilization",ans:"B"},
  {id:45,q:"Which crop is the primary source of starch in the Philippines?",A:"Corn",B:"Rice",C:"Cassava",D:"Sweet potato",ans:"A"},
  {id:46,q:"Which method of irrigation distributes water through small holes or emitters near plant roots?",A:"Flooding",B:"Sprinkler",C:"Drip irrigation",D:"Furrow",ans:"C"},
  {id:47,q:"What is the main purpose of mulching?",A:"Remove pests",B:"Increase evaporation",C:"Conserve soil moisture",D:"Reduce crop yield",ans:"C"},
  {id:48,q:"Which of the following is a sign of nitrogen deficiency?",A:"Yellowing of leaves",B:"Purple veins",C:"Brown spots",D:"Leaf curling",ans:"A"},
  {id:49,q:"Which process converts solar energy into chemical energy?",A:"Transpiration",B:"Respiration",C:"Photosynthesis",D:"Germination",ans:"C"},
  {id:50,q:"What is the ideal pH range for most crop plants?",A:"3.0â€“4.0",B:"5.5â€“7.0",C:"8.0â€“9.0",D:"9.5â€“10.5",ans:"B"},
  {id:51,q:"An ecosystem is best defined as:",A:"A community of plants only",B:"A habitat with only abiotic components",C:"A community of living organisms interacting with their physical environment",D:"A single species in an area",ans:"C"},
  {id:52,q:"The biotic component of an ecosystem includes:",A:"Sunlight and soil",B:"Plants, animals, and microorganisms",C:"Air and water",D:"Rocks and minerals",ans:"B"},
  {id:53,q:"The abiotic component of an ecosystem consists of:",A:"Only crops",B:"Livestock and insects",C:"Non-living physical and chemical factors like light, water, and temperature",D:"Bacteria",ans:"C"},
  {id:54,q:"In an agricultural ecosystem, the main producer organisms are:",A:"Cows and goats",B:"Green plants or crops",C:"Soil microbes",D:"Humans",ans:"B"},
  {id:55,q:"The term agroecosystem refers to:",A:"Natural forests",B:"Lakes and rivers",C:"A managed ecosystem where humans cultivate crops and raise livestock",D:"Mountain ranges",ans:"C"},
  {id:56,q:"Which of the following is not a component of an agroecosystem?",A:"Crops",B:"Soil microorganisms",C:"Plastic materials",D:"Livestock",ans:"C"},
  {id:57,q:"Which best describes the role of humans in an agroecosystem?",A:"Passive observers",B:"Managers who regulate inputs, outputs, and biodiversity",C:"Unrelated to ecosystem balance",D:"Inhibitors of plant growth only",ans:"B"},
  {id:58,q:"The main difference between natural ecosystems and agroecosystems is that:",A:"Agroecosystems are self-sustaining",B:"Natural ecosystems depend on fertilizers",C:"Agroecosystems require continuous human input and management",D:"Natural ecosystems lack biodiversity",ans:"C"},
  {id:59,q:"A balanced ecosystem maintains stability by:",A:"Overusing one resource",B:"Self-regulation through feedback mechanisms",C:"External fertilization",D:"Human control only",ans:"B"},
  {id:60,q:"The term biodiversity in an ecosystem refers to:",A:"Number of soil particles",B:"Variety of living organisms within an area",C:"Soil acidity",D:"Light intensity",ans:"B"},
  {id:61,q:"The trophic levels in an ecosystem represent:",A:"The physical layers of soil",B:"The different feeding positions in a food chain",C:"The growth stages of crops",D:"The water cycles",ans:"B"},
  {id:62,q:"The primary consumers in an agroecosystem are usually:",A:"Carnivores",B:"Decomposers",C:"Herbivores such as insects and grazing animals",D:"Producers",ans:"C"},
  {id:63,q:"Decomposers in agroecosystems play a key role by:",A:"Producing energy from sunlight",B:"Breaking down organic matter into nutrients",C:"Absorbing nitrogen from the air",D:"Killing pests",ans:"B"},
  {id:64,q:"Which of the following is a characteristic of an unstable agroecosystem ?",A:"Balanced nutrient cycles",B:"High biodiversity",C:"Dependence on external inputs and pest outbreaks",D:"Self-regulation",ans:"C"},
  {id:65,q:"The main energy source driving all ecosystems is:",A:"Water",B:"Sunlight",C:"Wind",D:"Organic matter",ans:"B"},
  {id:66,q:"The carrying capacity of an ecosystem is:",A:"The number of plants that can grow per hectare",B:"The total nutrient content",C:"The maximum population an environment can support sustainably",D:"The soilâ€™s pH range",ans:"C"},
  {id:67,q:"The main aim of studying agroecosystems is to:",A:"Increase chemical use",B:"Simplify food webs",C:"Understand interactions between crops, soil, and environment for better management",D:"Eliminate biodiversity",ans:"C"},
  {id:68,q:"The food chain in an ecosystem starts with:",A:"Carnivores",B:"Omnivores",C:"Producers",D:"Decomposers",ans:"C"},
  {id:69,q:"A food web differs from a food chain because it:",A:"Has fewer organisms",B:"Shows multiple interconnected feeding relationships",C:"Lacks decomposers",D:"Only includes carnivores",ans:"B"},
  {id:70,q:"The ecological niche of an organism refers to:",A:"Its genetic makeup",B:"Its population size",C:"Its specific role and habitat in an ecosystem",D:"Its geographic origin",ans:"C"},
  {id:71,q:"Crop monoculture affects ecosystems by:",A:"Enhancing biodiversity",B:"Reducing genetic diversity and ecosystem stability",C:"Increasing soil microorganisms",D:"Reducing pest attacks",ans:"B"},
  {id:72,q:"Humans alter ecosystems through activities such as:",A:"Conservation",B:"Deforestation, pollution, and land conversion",C:"Planting cover crops",D:"Organic farming",ans:"B"},
  {id:73,q:"Agroecosystems differ from natural ones mainly in:",A:"Nutrient self-sufficiency",B:"High human energy input and simplified structure",C:"Lack of living organisms",D:"Stability and diversity",ans:"B"},
  {id:74,q:"Which is a positive human impact on ecosystems?",A:"Overharvesting",B:"Use of pesticides without limit",C:"Reforestation and conservation programs",D:"Soil salinization",ans:"C"},
  {id:75,q:"The principle of ecological balance implies that:",A:"All populations are constant",B:"Ecosystems never change",C:"Species populations and resources adjust naturally through feedback mechanisms",D:"Humans can fully control nature",ans:"C"},
  {id:76,q:"The flow of energy in an ecosystem is described as:",A:"A cyclic process",B:"A reversible pathway",C:"A one-way movement from the sun through organisms to heat loss",D:"A closed loop system",ans:"C"},
  {id:77,q:"The first trophic level in the food chain consists of:",A:"Herbivores",B:"Carnivores",C:"Producers or autotrophs",D:"Decomposers",ans:"C"},
  {id:78,q:"The second law of thermodynamics implies that:",A:"Energy increases in each trophic level",B:"Some energy is always lost as heat during transfer",C:"Energy flows equally in all directions",D:"Energy is created and destroyed",ans:"B"},
  {id:79,q:"Which trophic level typically contains the most energy?",A:"Tertiary consumers",B:"Secondary consumers",C:"Producers",D:"Primary consumers",ans:"C"},
  {id:80,q:"The 10% energy rule states that:",A:"Only 10% of energy is lost between trophic levels",B:"Only about 10% of energy is transferred to the next level",C:"90% of energy accumulates",D:"Energy transfer is 100% efficient",ans:"B"},
  {id:81,q:"The cycling of nutrients in an ecosystem differs from energy flow because:",A:"Nutrients are lost permanently",B:"Energy is renewable",C:"Nutrients are recycled through biogeochemical cycles",D:"Energy cannot be stored",ans:"C"},
  {id:82,q:"The carbon cycle connects plants and animals through:",A:"Nitrogen fixation",B:"Photosynthesis and respiration",C:"Root exudates",D:"Leaching",ans:"B"},
  {id:83,q:"The nitrogen cycle is vital because:",A:"Nitrogen is abundant and inert",B:"Nitrogen has no biological role",C:"It converts atmospheric nitrogen into forms usable by plants",D:"It creates oxygen",ans:"C"},
  {id:84,q:"Which organisms are essential in nitrogen fixation?",A:"Fungi",B:"Rhizobium bacteria in legume root nodules",C:"Earthworms",D:"Nematodes",ans:"B"},
  {id:85,q:"The phosphorus cycle differs from nitrogen and carbon cycles because:",A:"It involves gases",B:"It lacks a significant atmospheric phase",C:"It produces energy",D:"It depends on photosynthesis",ans:"B"},
  {id:86,q:"Which human activity disrupts the nitrogen cycle?",A:"Forest conservation",B:"Natural grazing",C:"Overuse of fertilizers",D:"Crop rotation",ans:"C"},
  {id:87,q:"Eutrophication results from:",A:"Oxygen depletion due to excessive nutrient runoff",B:"Decline in soil pH only",C:"Introduction of new species",D:"Reduced sunlight",ans:"A"},
  {id:88,q:"Which process returns nutrients to the soil after organism death?",A:"Photosynthesis",B:"Decomposition",C:"Transpiration",D:"Nitrogen fixation",ans:"B"},
  {id:89,q:"Soil pollution often arises from:",A:"Use of organic manure",B:"Crop rotation",C:"Disposal of industrial and pesticide wastes",D:"Mulching",ans:"C"},
  {id:90,q:"Water pollution from farms is mainly caused by:",A:"Crop residues",B:"Runoff of fertilizers and pesticides into waterways",C:"Wind erosion",D:"Fish farming",ans:"B"},
  {id:91,q:"The greenhouse effect refers to:",A:"Heat loss from Earthâ€™s surface",B:"Trapping of heat by gases like COâ‚‚ and CHâ‚„",C:"Cloud formation",D:"Natural cooling of atmosphere",ans:"B"},
  {id:92,q:"Which of the following gases contributes most to global warming?",A:"Nitrogen",B:"Oxygen",C:"Carbon dioxide",D:"Argon",ans:"C"},
  {id:93,q:"Air pollution negatively impacts crops by:",A:"Increasing photosynthesis",B:"Strengthening cell walls",C:"Damaging leaf tissues and reducing photosynthetic activity",D:"Improving seed germination",ans:"C"},
  {id:94,q:"Acid rain is primarily caused by emissions of:",A:"Carbon dioxide and methane",B:"Ammonia and oxygen",C:"Sulfur dioxide and nitrogen oxides",D:"Chlorine and hydrogen",ans:"C"},
  {id:95,q:"One major consequence of soil erosion is:",A:"Increased organic matter",B:"Improved nutrient retention",C:"Loss of fertile topsoil and reduced productivity",D:"Decrease in sedimentation",ans:"C"},
  {id:96,q:"Biomagnification means:",A:"Decomposition of organic matter",B:"Increase of pollutant concentration along food chains",C:"Dilution of toxins",D:"Reduction of chemical residues",ans:"B"},
  {id:97,q:"Which farming practice helps reduce nutrient runoff?",A:"Excess fertilizer application",B:"Contour farming and buffer strips",C:"Overirrigation",D:"Deep tillage",ans:"B"},
  {id:98,q:"The energy pyramid shows that:",A:"Energy increases toward the top",B:"Energy decreases at higher trophic levels",C:"Energy remains constant",D:"Energy flows cyclically",ans:"B"},
  {id:99,q:"Sustainable nutrient management aims to:",A:"Maximize fertilizer use",B:"Avoid organic inputs",C:"Balance nutrient input and output for long-term fertility",D:"Depend solely on chemicals",ans:"C"},
  {id:100,q:"The overall goal of studying energy flow and nutrient cycling in crops is to:",A:"Eliminate ecological processes",B:"Simplify food webs",C:"Enhance productivity while maintaining ecological balance",D:"Increase pollution for faster growth",ans:"C"},
];

  // ===========================
  // QUIZ LOGIC
  // ===========================
  const el = id => document.getElementById(id);
  const stageName = el('stageName');
  const stageQuiz = el('stageQuiz');
  const stageResult = el('stageResult');
  const btnStart = el('btnStart');
  const inputName = el('studentName');
  const inputYS = el('yearSection');
  const qtext = el('qtext');
  const choicesEl = el('choices');
  const btnPrev = el('btnPrev');
  const btnNext = el('btnNext');
  const counter = el('counter');
  const who = el('who');
  const ysPill = el('ys');
  const timer = el('timer');
  const penaltiesBadge = el('penalties');
  const deductBadge = el('deduct');
  const bar = el('bar');
  const toast = el('toast');

  const resName = el('resName');
  const resYS = el('resYS');
  const resRaw = el('resRaw');
  const resPenalty = el('resPenalty');
  const resFinal = el('resFinal');

  function shuffle(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  const working = shuffle(QUESTIONS.map(x => ({...x})));
  const N = working.length;

  let idx = 0;
  let answers = Array(N).fill(null);
  let started = false;
  let secondsLeft = 60*60;
  let timerHandle = null;
  let tabSwitches = 0;

  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'), 1800);
  }

  function render(){
    counter.textContent = `Q: ${idx+1} / ${N}`;
    const q = working[idx];
    qtext.textContent = q.q; // no visible numbering
    choicesEl.innerHTML = '';
    ['A','B','C','D'].forEach(letter=>{
      const wrap = document.createElement('label');
      wrap.className='choice';
      wrap.innerHTML = `
        <input type="radio" name="opt" value="${letter}">
        <div><b>${letter}.</b> ${q[letter]}</div>
      `;
      choicesEl.appendChild(wrap);
    });
    if(answers[idx]){
      const sel = choicesEl.querySelector(`input[value="${answers[idx]}"]`);
      if(sel) sel.checked = true;
    }
    btnPrev.disabled = (idx===0);
    btnNext.textContent = (idx===N-1) ? 'Submit' : 'Next';
    bar.style.width = `${((idx)/Math.max(1,(N-1)))*100}%`;
  }

  function getSelected(){
    const sel = choicesEl.querySelector('input[name="opt"]:checked');
    return sel ? sel.value : null;
  }

  function toQuiz(){
    stageName.classList.remove('active');
    stageQuiz.classList.add('active');
    started = true;
    render();
    startTimer();
  }

  function computeSheetOrdered(){
    // Order by original id for admin review
    const map = new Map(working.map((q,i)=>[q.id,i]));
    const sheet = QUESTIONS
      .slice()
      .sort((a,b)=>a.id-b.id)
      .map(orig => {
        // find where this original question appeared in the randomized list
        const randomizedIndex = working.findIndex(w => w.id === orig.id);
        const chosen = answers[randomizedIndex] ?? null;
        return ({ 
          originalId: orig.id,
          text: orig.q,
          A: orig.A, B: orig.B, C: orig.C, D: orig.D,
          correct: orig.ans,
          chosen 
        });
      });
    return sheet;
  }

  function toResults(payload){
    stageQuiz.classList.remove('active');
    stageResult.classList.add('active');

    const {studentName, yearSection, rawScore, penalties, finalScore} = payload;
    resName.textContent = studentName;
    resYS.textContent = yearSection;
    resRaw.textContent = rawScore;
    resPenalty.textContent = penalties*10;
    resFinal.textContent = finalScore;
  }

  function computeAndSubmit(){
    let raw = 0;
    for (let i=0;i<N;i++){ if(answers[i] && answers[i] === working[i].ans) raw++; }
    const penalties = tabSwitches;
    const finalScore = Math.max(0, raw - penalties*10);
    const studentName = inputName.value.trim();
    const yearSection = inputYS.value.trim();
    const sheet = computeSheetOrdered();

    const payload = {
      studentName, yearSection,
      rawScore: raw, penalties, finalScore,
      secondsRemaining: secondsLeft,
      submittedAt: new Date().toISOString(),
    };

    (async ()=>{
      try{
        if (db && addDoc && collection){
          await addDoc(collection(db, "submissions"), {
            name: studentName,
            yearSection: yearSection,
            rawScore: raw,
            penalties,
            finalScore,
            secondsRemaining: secondsLeft,
            sheet, // full answer sheet in canonical order
            createdAt: serverTimestamp()
          });
        }
      }catch(err){
        console.warn("Firestore write failed:", err);
      }finally{
        toResults(payload);
      }
    })();
  }

  function next(){
    const sel = getSelected();
    if(!sel){
      showToast("Please choose an answer before proceeding.");
      return;
    }
    answers[idx] = sel;
    if(idx === N-1){
      clearInterval(timerHandle);
      computeAndSubmit();
    }else{
      idx++;
      render();
    }
  }

  function prev(){
    if(idx>0){
      const sel = getSelected();
      if(sel) answers[idx] = sel;
      idx--;
      render();
    }
  }

  function startTimer(){
    function fmt(s){
      const m = Math.floor(s/60), ss = s%60;
      return `${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
    }
    timer.textContent = `Time: ${fmt(secondsLeft)}`;
    timerHandle = setInterval(()=>{
      secondsLeft--;
      if(secondsLeft<=0){
        clearInterval(timerHandle);
        answers[idx] = getSelected() ?? answers[idx];
        computeAndSubmit();
      }else{
        timer.textContent = `Time: ${fmt(secondsLeft)}`;
      }
    },1000);
  }

  document.addEventListener('visibilitychange', ()=>{
    if (!started) return;
    if (document.hidden){
      tabSwitches++;
      penaltiesBadge.textContent = `Tab switches: ${tabSwitches}`;
      deductBadge.textContent = `Penalty: ${tabSwitches*10}`;
      showToast("Tab change detected: -10 points.");
    }
  });

  btnStart.addEventListener('click', ()=>{
    const nm = inputName.value.trim();
    const ys = inputYS.value.trim();
    if(!nm) { showToast("Please enter your full name."); return; }
    if(!ys) { showToast("Please enter your Year & Section."); return; }
    who.textContent = `Name: ${nm}`;
    ysPill.textContent = `Year/Section: ${ys}`;
    toQuiz();
  });
  inputName.addEventListener('keydown',(e)=>{ if(e.key==='Enter') btnStart.click(); });
  inputYS.addEventListener('keydown',(e)=>{ if(e.key==='Enter') btnStart.click(); });
  btnNext.addEventListener('click', next);
  btnPrev.addEventListener('click', prev);

  document.addEventListener('keydown', (e)=>{
    if(!stageQuiz.classList.contains('active')) return;
    if(['1','2','3','4','a','b','c','d','A','B','C','D'].includes(e.key)){
      const map = { '1':'A','2':'B','3':'C','4':'D' };
      const v = map[e.key] || e.key.toUpperCase();
      const radio = choicesEl.querySelector(`input[value="${v}"]`);
      if(radio) radio.checked = true;
    } else if(e.key === 'ArrowRight'){ next(); }
      else if(e.key === 'ArrowLeft'){ prev(); }
  });
</script>
</body>
</html>
