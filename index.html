<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>CropSci Final Exam</title>
  <style>
    body {
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;
      background:#0f172a;
      color:#e5e7eb;
    }
    .wrap {
      max-width:960px;
      margin:0 auto;
      padding:24px;
    }
    .card {
      background:#111827;
      border:1px solid #1f2937;
      border-radius:16px;
      padding:20px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h1,h2 {
      margin:0 0 10px 0;
      color:#e2e8f0;
    }
    ul {
      padding-left:20px;
    }
    .pill {
      padding:6px 10px;
      border-radius:999px;
      background:#111827;
      border:1px solid #1f2937;
      font-size:12px;
      margin-right:6px;
      display:inline-block;
    }
    .meta-row {
      margin-bottom:10px;
    }
    .field {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:10px 0;
    }
    input[type="text"] {
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #334155;
      background:#0b1220;
      color:#e5e7eb;
      flex:1;
      min-width:220px;
    }
    button {
      padding:10px 16px;
      border-radius:12px;
      border:1px solid #263042;
      background:#0b1326;
      color:#e5e7eb;
      cursor:pointer;
    }
    button.primary {
      background:#0d5a30;
    }
    button:disabled {
      opacity:.6;
      cursor:not-allowed;
    }
    .progress {
      height:8px;
      background:#1f2937;
      border-radius:999px;
      margin-bottom:12px;
      overflow:hidden;
    }
    .bar {
      height:100%;
      width:0%;
      background:#22c55e;
      transition:width .2s ease-out;
    }
    #choices {
      display:flex;
      flex-direction:column;
      gap:12px;
      width:100%;
    }
    .choice {
      display:flex;
      flex-direction:row;
      align-items:flex-start;
      width:100%;
      max-width:100% !important;
      background:#0b1220;
      border:1px solid #1f2937;
      border-radius:10px;
      padding:12px;
      box-sizing:border-box;
    }
    .choice input {
      margin-top:4px;
      flex-shrink:0;
    }
    .choice div {
      flex:1;
      white-space:normal !important;
      overflow-wrap:break-word !important;
      word-break:break-word !important;
    }
    .choice b {
      display:inline-block;
      width:22px;
    }
    .footer {
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:20px;
      flex-wrap:wrap;
    }
    .hidden {
      display:none;
    }
    .error {
      color:#fecaca;
      font-size:13px;
      margin-top:6px;
    }
    .small {
      font-size:12px;
      color:#9ca3af;
    }
    @media (max-width:600px) {
      .footer {
        flex-direction:column;
        align-items:stretch;
      }
      button {
        width:100%;
      }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>CropSci Final Exam</h1>

    <div id="meta" class="meta-row hidden">
      <span class="pill" id="pillName">Name: —</span>
      <span class="pill" id="pillSection">Year/Section: —</span>
      <span class="pill" id="pillTimer">Time: 60:00</span>
      <span class="pill" id="pillCount">Q: — / —</span>
    </div>

    <!-- Stage 0 -->
    <section id="stage0">
      <h2>Exam Instructions</h2>
      <ul>
        <li>This exam is <strong>screen recorded</strong>.</li>
        <li>You have <strong>1 hour</strong> to finish once you start.</li>
        <li>You may take the exam <strong>twice</strong>.</li>
        <li>The link closes at <strong>11:59:59 PM on 21 November 2025</strong>.</li>
      </ul>
      <p class="small">Make sure you have a stable internet connection. Do not close the tab.</p>
      <div class="error" id="errStage0" style="display:none;"></div>
      <button class="primary" id="btnUnderstand">I understand</button>
    </section>

    <!-- Stage 1 -->
    <section id="stage1" class="hidden">
      <h2>Student Information</h2>
      <div class="field">
        <input type="text" id="inpName" placeholder="Full Name"/>
        <input type="text" id="inpSection" placeholder="Year & Section"/>
      </div>
      <div class="error" id="errStage1" style="display:none;"></div>
      <div class="footer">
        <button id="btnBack">Back</button>
        <button class="primary" id="btnStart">Next</button>
      </div>
    </section>

    <!-- Stage 2 -->
    <section id="stage2" class="hidden">
      <div class="progress"><div id="bar" class="bar"></div></div>
      <p id="qtext"></p>
      <div id="choices"></div>
      <div class="error" id="errStage2" style="display:none;"></div>
      <div class="footer">
        <button id="btnPrev">Review</button>
        <div>
          <button id="btnNext" class="primary">Next</button>
          <button id="btnSubmit" class="primary hidden">Submit</button>
        </div>
      </div>
    </section>

    <!-- Stage 3 -->
    <section id="stage3" class="hidden">
      <h2>Submission Complete</h2>
      <p><strong id="rName"></strong> (<span id="rSection"></span>)</p>
      <p>Your Score: <strong id="rScore"></strong></p>
      <p class="small">Your answers have been saved to the database.</p>
      <p class="error" id="rNote" style="display:none;"></p>
    </section>

  </div>
</div>

<script type="module">

/* =============================
   REPLACED QUESTIONS (NEW SET)
   ============================= */

const QUESTIONS = [
  {num:1,q:"Lowland crop production is commonly characterized by:",A:"Steep slopes and poor soils",B:"Extremely dry conditions all year",C:"Flat or gently sloping land with access to standing or controlled water",D:"Only tree crops planted in rows",ans:"C"},
  {num:2,q:"Upland farming is BEST described as crop production in:",A:"Flooded paddies",B:"Terraced hill slopes or well-drained higher areas",C:"Coastal marshes",D:"River deltas with standing water",ans:"B"},
  {num:3,q:"A farmer with an upland corn field on a sloping area wants to reduce soil erosion. Which practice is most appropriate?",A:"Continuous monocropping with deep plowing",B:"Contour plowing and planting hedgerows",C:"Burning crop residues every season",D:"Leaving the soil bare after harvest",ans:"B"},
  {num:4,q:"Which of the following management strategies is MOST suitable for lowland rice production?",A:"Drip irrigation and permanent ridges",B:"Flood irrigation and transplanting seedlings",C:"No weeding for biodiversity",D:"Growing only perennial trees",ans:"B"},
  {num:5,q:"A comparison shows that an upland farm has higher erosion and lower water retention than a lowland farm. What is the MOST likely reason?",A:"Upland farms are always fertilized less",B:"Upland farms are on steeper slopes with faster runoff",C:"Lowland farms never use fertilizers",D:"Lowland farms always receive less rainfall",ans:"B"},
  {num:6,q:"Which statement BEST defines sustainable agriculture?",A:"Farming that uses as many chemicals as possible",B:"Farming that maximizes yield in a single season only",C:"Farming that meets present needs without compromising future generations",D:"Farming that focuses only on export crops",ans:"C"},
  {num:7,q:"One key feature of sustainable crop production is:",A:"Continuous monocropping without rotation",B:"Excessive tillage of the soil",C:"Conservation of soil, water, and biodiversity",D:"Complete removal of crop residues",ans:"C"},
  {num:8,q:"A farmer wants to shift toward more sustainable practices. Which of the following changes best demonstrates this?",A:"Increasing pesticide doses each year",B:"Replacing all organic inputs with synthetic fertilizers",C:"Introducing crop rotation and reduced tillage",D:"Burning weeds and residues after every harvest",ans:"C"},
  {num:9,q:"Why is maintaining soil organic matter important in sustainable crop production?",A:"It increases soil compaction",B:"It reduces water infiltration",C:"It improves soil structure, water-holding capacity, and fertility",D:"It removes all soil organisms",ans:"C"},
  {num:10,q:"A farm is highly productive but leads to rapid soil degradation and water pollution. From a sustainability perspective, how should this system be evaluated?",A:"It is very successful because it has high yield",B:"It is unsustainable due to long-term resource damage",C:"It is sustainable because inputs are cheap",D:"It cannot be judged without market data",ans:"B"},
  {num:11,q:"Agricultural diversification primarily means:",A:"Planting the same crop every year",B:"Integrating different crops, varieties, or enterprises on the farm",C:"Using only one type of fertilizer",D:"Reducing the number of products sold",ans:"B"},
  {num:12,q:"Which example shows diversification at the farm level?",A:"Rice monocropping for 10 years",B:"Rice–vegetable–corn rotation with small livestock",C:"Only mango orchard with no other activity",D:"Only sugarcane on all fields",ans:"B"},
  {num:13,q:"A farmer wants to reduce income risk from market price fluctuations. Which strategy best applies diversification?",A:"Depend on a single cash crop",B:"Plant multiple crops with different harvest times and markets",C:"Apply more chemical fertilizer",D:"Sell only to one buyer",ans:"B"},
  {num:14,q:"Data show that diversified farms were less affected by a pest outbreak than monocropped farms. What is the MOST logical explanation?",A:"Pests prefer diversified farms",B:"Diversification reduces host concentration and spreads risk",C:"Diversified farms use no pesticides",D:"Farmers on diversified farms are richer",ans:"B"},
  {num:15,q:"A student is assessing a policy that promotes diversification in small farms. From a sustainability viewpoint, which is the BEST remark?",A:"It is harmful because it confuses farmers",B:"It is beneficial as it supports resilience, income stability, and resource use efficiency",C:"It should be avoided to keep farming simple",D:"It is unnecessary because markets prefer one product",ans:"B"},
  {num:16,q:"Which of the following is a resource conservation practice?",A:"Burning crop residues",B:"Terracing sloping lands",C:"Continuous deep plowing",D:"Removing all trees from farm boundaries",ans:"B"},
  {num:17,q:"Mulching mainly helps in:",A:"Increasing evaporation",B:"Conserving soil moisture and reducing erosion",C:"Raising soil temperature extremely",D:"Killing soil organisms",ans:"B"},
  {num:18,q:"A farmer plants nitrogen-fixing trees on farm boundaries and uses their prunings as green manure. What resource-related benefit is primarily targeted?",A:"Increased soil salinity",B:"Soil fertility improvement and nutrient recycling",C:"Complete removal of soil organic matter",D:"Reduced biodiversity",ans:"B"},
  {num:19,q:"Soil tests reveal declining organic matter over several years. What is the MOST appropriate conclusion?",A:"The soil is improving",B:"The soil is losing fertility and structure, indicating poor conservation",C:"Organic matter does not affect soil quality",D:"Fertilizer rates are too high",ans:"B"},
  {num:20,q:"A government program promotes agroforestry as a strategy for resource regeneration. From a policy viewpoint, how should this be evaluated?",A:"Ineffective, because trees never help crops",B:"Positive, because agroforestry can restore soil, provide income, and enhance biodiversity",C:"Irrelevant to climate and soil",D:"Harmful, because trees always compete with crops",ans:"B"},
  {num:21,q:"In the context of farming systems, “stability” refers to:",A:"Maximum yield in a single year",B:"Consistent performance over time under variable conditions",C:"Using only one input",D:"Avoiding any technology",ans:"B"},
  {num:22,q:"Which practice can contribute to more stable yields?",A:"Continuous monocropping",B:"Crop rotation and use of tolerant varieties",C:"Over-irrigation",D:"Removing trees and hedgerows",ans:"B"},
  {num:23,q:"A farmer notices that yields fluctuate widely from year to year due to drought. Which adaptation BEST applies the goal of stability?",A:"Continue with the same variety",B:"Shift to drought-tolerant varieties and adopt water conservation practices",C:"Reduce soil organic matter",D:"Avoid any changes",ans:"B"},
  {num:24,q:"Yield data show that two farms have the same average yield, but Farm A has very large fluctuations while Farm B has small fluctuations. What can be concluded?",A:"Farm A is more stable",B:"Farm B is more stable",C:"Both are equally stable",D:"Stability cannot be compared",ans:"B"},
  {num:25,q:"A development project focuses only on maximizing short-term yield without considering stability or resource health. How should this be evaluated?",A:"Highly sustainable",B:"Potentially harmful in the long term",C:"Always beneficial",D:"Unrelated to sustainability",ans:"B"},
  {num:26,q:"Biotechnology in crop production mainly aims to:",A:"Increase soil erosion",B:"Develop crops with improved traits like pest resistance or stress tolerance",C:"Remove all genetic diversity",D:"Eliminate the need for management",ans:"B"},
  {num:27,q:"An example of a biotechnological tool in crop improvement is:",A:"Manual weeding",B:"Tissue culture for clonal propagation",C:"Burning stubbles",D:"Tractor plowing",ans:"B"},
  {num:28,q:"A farmer adopts a genetically modified (GM) Bt corn variety that resists specific insect pests. What is the primary intended benefit?",A:"More weeds",B:"Reduced damage from targeted insect pests",C:"Increased need for insecticide",D:"Lower yields",ans:"B"},
  {num:29,q:"In tissue culture, plants are produced under sterile conditions from small tissue pieces. How does this practice apply in seedling production?",A:"Producing non-uniform seedlings",B:"Producing disease-free, uniform planting materials",C:"Increasing pathogen spread",D:"Reducing the number of seedlings",ans:"B"},
  {num:30,q:"A study finds that a new biotechnology-based variety increases yield but reduces on-farm biodiversity and raises seed cost. From a sustainability viewpoint, what is the best analysis?",A:"Only the yield effect matters",B:"Trade-offs must be weighed between higher productivity and potential biodiversity loss or reduced farmer autonomy",C:"The variety must be banned immediately",D:"Biodiversity is irrelevant",ans:"B"},
  {num:31,q:"One concern about the World Trade Organization (WTO) agreements in relation to agriculture is that they may:",A:"Encourage only subsistence farming",B:"Affect national policies on seed trade, intellectual property, and biodiversity",C:"Ban all international trade",D:"Prohibit the use of local varieties",ans:"B"},
  {num:32,q:"Farmers’ rights in the context of seeds generally refer to:",A:"The right of companies to patent seeds",B:"The right of governments to control all seeds",C:"The right of farmers to save, use, exchange, and sometimes sell farm-saved seed",D:"The right to remove all local varieties",ans:"C"},
  {num:33,q:"A seed company owns a patent on a new variety and restricts farmers from saving seeds. How does this apply patent laws?",A:"Farmers have full freedom to reuse seeds",B:"Farmers must buy new seeds each season under patent rules",C:"Farmers may ignore the patent",D:"The patent has no effect",ans:"B"},
  {num:34,q:"A country joins an international agreement that promotes fair sharing of benefits from plant genetic resources. How will this likely impact biodiversity conservation?",A:"Discourage conservation",B:"Encourage conservation by recognizing the role of biodiversity custodians",C:"Eliminate traditional varieties",D:"No impact",ans:"B"},
  {num:35,q:"A policy is proposed that ignores farmers’ traditional knowledge and focuses only on corporate patents. How should it be evaluated?",A:"Fair and balanced",B:"Potentially unjust, as it undermines farmers’ rights and local innovation",C:"Neutral",D:"Ideal for all stakeholders",ans:"B"},
  {num:36,q:"Government agricultural programs commonly aim to:",A:"Reduce food production",B:"Support farmers, improve productivity, and ensure food security",C:"Eliminate extension services",D:"Increase food prices only",ans:"B"},
  {num:37,q:"A subsidy for small farmers to adopt soil conservation technologies is an example of government support that:",A:"Encourages resource degradation",B:"Promotes sustainable land management",C:"Prevents technology adoption",D:"Has no effect",ans:"B"},
  {num:38,q:"A local government launches a program providing training on climate-smart agriculture. How does this apply to farmers?",A:"They learn outdated practices only",B:"They learn adaptive methods like water-saving and resilient varieties",C:"They are forced to quit farming",D:"They lose market access",ans:"B"},
  {num:39,q:"An evaluation shows that some government programs increase dependency on external inputs without improving soil health. How should these be analyzed?",A:"Automatically successful",B:"Weak in promoting sustainability despite short-term support",C:"Guarantees long-term resilience",D:"No measurable effect",ans:"B"},
  {num:40,q:"When assessing a new government agriculture program, which criterion is MOST important from a sustainability perspective?",A:"Political popularity",B:"Contribution to farmer welfare, environmental health, and long-term productivity",C:"Branding",D:"Media coverage",ans:"B"},
  {num:41,q:"Climate-smart agriculture (CSA) aims to:",A:"Increase emissions",B:"Increase productivity, enhance resilience, and reduce greenhouse gas emissions",C:"Focus on yield only",D:"Ban all fertilizers",ans:"B"},
  {num:42,q:"Which of the following is an example of a climate-smart practice?",A:"Over-irrigation",B:"Use of drought-tolerant varieties and water-harvesting",C:"Burning crop residues",D:"Removing ground cover",ans:"B"},
  {num:43,q:"A farmer uses a mobile app that gives site-specific fertilizer recommendations. This is an example of:",A:"Traditional guesswork",B:"Application of AI and decision-support tools",C:"Manual calculation",D:"Random decision-making",ans:"B"},
  {num:44,q:"Yield maps and satellite images analyzed by AI adjust planting density across the field. What does this show?",A:"AI cannot use spatial data",B:"AI optimizes inputs based on field variability",C:"AI only works in labs",D:"AI replaces farmers completely",ans:"B"},
  {num:45,q:"A proposal suggests investing in AI tools only for large plantations while ignoring smallholders. How should it be evaluated?",A:"Completely fair",B:"Potentially problematic because it widens gaps",C:"Ideal for all farmers",D:"Unrelated",ans:"B"},
  {num:46,q:"Value-adding in crop production refers to:",A:"Selling raw produce only",B:"Processing or packaging crops to increase market value",C:"Reducing product quality",D:"Discarding surplus produce",ans:"B"},
  {num:47,q:"Turning fresh tomatoes into bottled tomato sauce is an example of:",A:"Primary production only",B:"Value-adding that increases shelf life and income",C:"Resource waste",D:"Soil conservation",ans:"B"},
  {num:48,q:"Urban farming is best described as:",A:"Farming only in rural villages",B:"Crop and livestock production within or around cities",C:"Marine fishing",D:"Forest plantations",ans:"B"},
  {num:49,q:"A city government promotes rooftop gardening and provides starter kits. What is the MOST likely impact?",A:"Reduced access to fresh vegetables",B:"Increased local food supply and community engagement",C:"Higher food transport costs",D:"Lower environmental awareness",ans:"B"},
  {num:50,q:"A farmer brands her own peanut butter instead of selling raw peanuts. How is this decision evaluated?",A:"Risky with no benefit",B:"Value-adding that can increase profit with good quality and marketing",C:"Always loss-making",D:"Unrelated to farm income",ans:"B"}
];

/* =====================================
   FIREBASE + EXAM LOGIC (UNCHANGED)
   ===================================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, doc, setDoc, serverTimestamp }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, signInAnonymously }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyB-idZOq8h9sVttNdzXE2t8FMoYI_snq7g",
  authDomain: "kuya-quiz-100.firebaseapp.com",
  projectId: "kuya-quiz-100",
  storageBucket: "kuya-quiz-100.appspot.com",
  messagingSenderId: "74623975270",
  appId: "1:74623975270:web:dec2b21dbee017292952a7"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
try { await signInAnonymously(auth); } catch(e){ console.warn("Auth failed:",e); }

const EXAM_DOC_ID = "KzRzubb5df1TV1gL2RuF";
const COURSE_TITLE = document.title;
const EXAM_SECONDS = 60 * 60;
const CLOSING_TIME = new Date(2025,10,21,23,59,59);

const stage0 = document.getElementById("stage0");
const stage1 = document.getElementById("stage1");
const stage2 = document.getElementById("stage2");
const stage3 = document.getElementById("stage3");

const errStage0 = document.getElementById("errStage0");
const errStage1 = document.getElementById("errStage1");
const errStage2 = document.getElementById("errStage2");

const btnUnderstand = document.getElementById("btnUnderstand");
const btnBack = document.getElementById("btnBack");
const btnStart = document.getElementById("btnStart");
const btnPrev = document.getElementById("btnPrev");
const btnNext = document.getElementById("btnNext");
const btnSubmit = document.getElementById("btnSubmit");

const inpName = document.getElementById("inpName");
const inpSection = document.getElementById("inpSection");
const qtext = document.getElementById("qtext");
const choicesEl = document.getElementById("choices");
const barEl = document.getElementById("bar");

const metaRow = document.getElementById("meta");
const pillName = document.getElementById("pillName");
const pillSection = document.getElementById("pillSection");
const pillTimer = document.getElementById("pillTimer");
const pillCount = document.getElementById("pillCount");

const rName = document.getElementById("rName");
const rSection = document.getElementById("rSection");
const rScore = document.getElementById("rScore");

let currentIndex = 0;
let selectedAnswers = new Array(QUESTIONS.length).fill(null);
let secondsLeft = EXAM_SECONDS;
let timerId = null;
let studentId = null;
let studentName = "";
let studentSection = "";
let submitting = false;

function isClosed(){ return new Date() > CLOSING_TIME; }
function showErr(el,msg){ el.textContent = msg; el.style.display = msg?"block":"none"; }
function switchStage(st){ stage0.classList.add("hidden");stage1.classList.add("hidden");stage2.classList.add("hidden");stage3.classList.add("hidden"); st.classList.remove("hidden"); }

function renderQuestion(){
  const q = QUESTIONS[currentIndex];
  qtext.textContent = q.q;
  choicesEl.innerHTML = "";
  ["A","B","C","D"].forEach(l=>{
    const checked = selectedAnswers[currentIndex]===l ? " checked":"";
    choicesEl.insertAdjacentHTML("beforeend",
      `<label class="choice">
        <input type="radio" name="opt" value="${l}"${checked}>
        <div><b>${l}.</b> ${q[l]}</div>
      </label>`);
  });
  pillCount.textContent = `Q: ${currentIndex+1} / ${QUESTIONS.length}`;
  barEl.style.width = (currentIndex/(QUESTIONS.length-1))*100+"%";

  btnPrev.disabled = currentIndex===0;
  if(currentIndex===QUESTIONS.length-1){
    btnNext.classList.add("hidden");
    btnSubmit.classList.remove("hidden");
  } else {
    btnNext.classList.remove("hidden");
    btnSubmit.classList.add("hidden");
  }
  showErr(errStage2,"");
}

function getSelectedValue(){
  const s = choicesEl.querySelector("input[name='opt']:checked");
  return s ? s.value : null;
}

function startTimer(){
  secondsLeft = EXAM_SECONDS;
  if(timerId) clearInterval(timerId);
  timerId = setInterval(()=>{
    secondsLeft--;
    const m = Math.floor(secondsLeft/60), s = secondsLeft%60;
    pillTimer.textContent = `Time: ${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    if(secondsLeft<=0){ clearInterval(timerId); autoSubmit(); }
  },1000);
}

async function getAttemptCountForStudent(id){
  try{
    const attemptsCol = collection(db,"finals-exam",EXAM_DOC_ID,"submissions",id,"attempts");
    const snap = await getDocs(attemptsCol);
    return snap.size;
  } catch(e){ return 0; }
}

function computeScore(){
  let s=0;
  for(let i=0;i<QUESTIONS.length;i++){
    if(selectedAnswers[i]===QUESTIONS[i].ans) s++;
  }
  return s;
}

function buildAnswerSheet(){
  return QUESTIONS.map((q,i)=>({
    questionNumber:q.num,
    question:q.q,
    options:{A:q.A,B:q.B,C:q.C,D:q.D},
    correctAnswer:q.ans,
    chosenAnswer:selectedAnswers[i],
    isCorrect:selectedAnswers[i]===q.ans
  }));
}

btnUnderstand.addEventListener("click",()=>{
  if(isClosed()){ showErr(errStage0,"This exam is already closed."); return; }
  switchStage(stage1);
});

btnBack.addEventListener("click",()=>switchStage(stage0));

btnStart.addEventListener("click",async()=>{
  if(isClosed()){ showErr(errStage1,"This exam is already closed."); return; }

  const nm = inpName.value.trim(), sec = inpSection.value.trim();
  if(!nm){ showErr(errStage1,"Enter your name."); return; }
  if(!sec){ showErr(errStage1,"Enter your section."); return; }
  showErr(errStage1,"");

  studentName = nm;
  studentSection = sec;
  let raw = nm+"|||"+sec+"|||"+COURSE_TITLE;
  let base;
  try{ base = btoa(unescape(encodeURIComponent(raw))); }
  catch(e){ base = raw; }
  studentId = base.replace(/[^A-Za-z0-9]/g,"").slice(0,80) || "student";

  const attemptCount = await getAttemptCountForStudent(studentId);
  if(attemptCount>=2){ showErr(errStage1,"You have used your 2 attempts."); return; }

  metaRow.classList.remove("hidden");
  pillName.textContent="Name: "+studentName;
  pillSection.textContent="Year/Section: "+studentSection;

  currentIndex=0;
  selectedAnswers=new Array(QUESTIONS.length).fill(null);

  switchStage(stage2);
  renderQuestion();
  startTimer();
});

btnNext.addEventListener("click",()=>{
  const sel=getSelectedValue();
  if(!sel){ showErr(errStage2,"Choose an answer."); return; }
  selectedAnswers[currentIndex]=sel;
  currentIndex++; renderQuestion();
});

btnPrev.addEventListener("click",()=>{
  const sel=getSelectedValue();
  if(sel) selectedAnswers[currentIndex]=sel;
  currentIndex--; renderQuestion();
});

btnSubmit.addEventListener("click",()=>{
  const sel=getSelectedValue();
  if(!sel){ showErr(errStage2,"Choose an answer."); return; }
  selectedAnswers[currentIndex]=sel;
  submitExam(false);
});

async function submitExam(auto){
  if(submitting) return;
  submitting=true;
  btnSubmit.disabled=true; btnNext.disabled=true; btnPrev.disabled=true;
  if(timerId){ clearInterval(timerId); timerId=null; }

  const score = computeScore();
  const answerSheet = buildAnswerSheet();

  const payload = {
    Course:COURSE_TITLE,
    submissionDate:serverTimestamp(),
    Score:score,
    Name:studentName,
    secondsRemaining:secondsLeft,
    section:studentSection,
    answers:answerSheet,
    autoSubmitted:!!auto
  };

  try{
    const attemptsCol = collection(db,"finals-exam",EXAM_DOC_ID,"submissions",studentId,"attempts");
    const snap = await getDocs(attemptsCol);
    const attemptNum = snap.size + 1;
    const ref = doc(db,"finals-exam",EXAM_DOC_ID,"submissions",studentId,"attempts","attempt"+attemptNum);
    await setDoc(ref,payload);

    alert("Your exam has been submitted.");
    rName.textContent=studentName;
    rSection.textContent=studentSection;
    rScore.textContent=score+" / "+QUESTIONS.length;
    switchStage(stage3);
  } catch(e){
    alert("Submission failed. Please try again.");
    if(secondsLeft>0) startTimer();
    submitting=false;
  }
}

async function autoSubmit(){
  if(submitting) return;
  const sel = getSelectedValue();
  if(sel) selectedAnswers[currentIndex]=sel;
  await submitExam(true);
}

pillTimer.textContent="Time: 60:00";
pillCount.textContent="Q: — / "+QUESTIONS.length;

</script>
</body>
</html>
